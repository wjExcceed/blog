---
title: TCP/UDP的归纳总结
date: 2017-08-20 18:39:36
tags: [record, network]
categories: 聚沙成塔
---

<!--TOC-->

&emsp;&emsp;运输层是整个网络体系结构中的关键层次之一，它有一个很重要的功能就是复用和分用。这里的“复用”是指在发送方不同的应用进程都可以使用同一个运输层协议传输数据，而“分用”是指接收方的运输层在剥去报文的首部后就能够把这些数据正确交付到目的应用进程。
<!--more-->

从这里可以看出网络层和运输层有明显的区别。网络层是为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信。

## 用户数据协议UDP的特点

- UDP是无连接的，即发送数据之前不需要建立连接（当然发送数据结束时也没有连接可以释放），因此减少了开销和发送数据之前的时延。

- UDP使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表。

- UDP是面向报文的。发送方的UDP对应用程序交下来的报文，在添加手部后就向下交付给IP层。UDP对应用层家下来的报文，既不合并，也不拆分，而是保留这些文件的边界。

- UDP没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对实时应用是很重要的。很多实时应用（如IP电话、实时视频会议等）要求源主机以恒定的速率发送数据，并且允许在网络发生拥塞时丢失一些数据，但却不允许数据有太大的时延。

- UDP支持一对一、一对多、多对一和多对多的交互通信。

- UDP的首部开销校，只有8个字节，比TCP的20个字节的首部要短。

## UDP的首部格式

{% asset_img UDP用户数据报的首部和伪首部.JPG UDP用户数据报的首部和伪首部 %}

&emsp;&emsp;用户数据包UDP有两个字段：数据字段和首部字段。首部字段很简单，只有8个字节，由四个字段组成，每个字段的长度都是两个字节。各字段意义如下：
(1)源端口：	源端口号，在需要对方回信时选用，不需要时可用全0。
(2)目的端口：	目的端口号。这在重点交付报文时必须要使用到。	
(3)长度：	UDP用户数据包的长度，其最小值是8（仅有首部）
(4)检验和：	检测UDP用户数据包在传输中是否有错。有错就丢弃。
注意：IP数据包的检验和只检验IP数据包的首部，但UDP的检验和是把首部和数据部分一起都检验。

## 传输控制协议TCP的特点

- TCP是面向连接的运输层协议。这就是说，应用程序在使用TCP协议之前，必须先建立TCP连接。在传输数据完毕后，必须释放已经建立的TCP连接。

- 每一条TCP连接只能有两个端点。每一条TCP连接只能是点对点的（一对一）。

- TCP提供可靠交付的服务。也就是说，通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达。

- TCP提供全双工通信。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。在发送时，应用程序在把数据传送给TCP缓存后，就可以做自己的事，而TCP在合适的时候把数据发送出去。在接收时，TCP把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。

- 面向字节流。TCP中的“流”指的是流入到进程或从进程流出的字节序列。“面向字节流”的含义是虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序交下来的数据看成仅仅是一连串的无结构字节流。TCP并不知道所传送的字节流的含义。TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系。

## TCP报文段的首部格式

TCP虽然是面向字节流的，但TCP传送的数据单元却是报文段。一个TCP报文段分为首部和数据两部分。TCP报文段首部的前20个字节是固定的，后面有4N字节是根据需要而增加的选项。所以TCP首部的最小长度是20字节。

{% asset_img TCP报文段的首部格式.JPG TCP报文段的首部格式 %}

(1)源端口和目的端口：	各占两个字节，与UDP的分用相似，TCP的分用功能也是通过端口实现。

(2)序号：	占4字节。TCP是面向字节流的。在一个TCP连接中传送的字节流中的每一个字节都按顺序编号。整个要传送的字节流的起始序号必须在连接建立时设置。首部中的序号字段值指的是本报文段所发送的数据的第一个字节的序号。

(3)确认号：	占4字节。是期望收到对方下一个报文段的第一个数据字节的序号。
**若确认号=N，则表明：到序号N-1为止的所有数据都已正确收到。**

(4)数据偏移：	占4bit。他指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。这个字段实际上指出TCP报文段的首部长度。

(5)保留：	占6bit。保留为今后使用，目前应置为0。

(6)紧急URG：	1bit。当URG=1时，表明紧急指针字段有效。他告诉系统此报文段中有紧急数据，应尽快传送，而不按原来的排队顺序来传送。于是发送方TCP就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍是普通数据，这时要与首部中紧急指针字段配合使用。

(7)确认ACK：	1bit。仅当ACK=1时确认号字段才有效。当ACK=0时，确认号无效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置为1。

(8)推送PSH：	1bit。当两个应用进程进行交互式通信时，有时在一端的应用进程希望在键入一个命令后立即就能够收到对方的响应。在这种情况下，TCP就可以使用推送操作。这时，发送方TCP把PSH置为1，并立即创建一个报文段发送出去。接收方TCP收到PSH=1的报文段，就尽快地交付给接收应用进程，而不再等到整个缓存都填满了之后再向上交付。

(9)复位RST：	1bit。当RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立运输连接。RST置为1还用来拒绝一个非法的报文段或拒绝打开一个连接。

(10)同步SYN：	1bit。在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN=1和ACK=1。因此，SYN置为1表示这是一个连接请求或连接接收报文。

(11)终止FIN：	1bit。用来释放一个连接。当FIN=1时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。

(12)窗口：	占2个字节。窗口值是0~2^16-1之间的整数。窗口指的是发送本报文段的一方的接收窗口。窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方放松的数据量。窗口值作为接收方让发送方设置其发送窗口的依据。

(13)检验和：	占2个字节。检验和字段检验的范围包括首部和数据两部分。和UDP用户数据报一样，在计算检验和时，要在TCP报文段的前面加上12字节的伪首部。TCP的协议号为6，

(14)紧急指针：	占2个字节。紧急指针仅在URG=1时有意义，它指出本报文段中的紧急数据的字节数，紧急指针指出了紧急数据的末尾在报文段中的位置。值得注意的是，即使窗口为0时也可放松紧急数据。

(15)选项：	长度可变，最长可达40字节。当没有使用选项时，TCP的首部长度是20字节。TCP的最大报文段长度MSS默认情况下536字节。MSS是每一个TCP报文段中的数据字段的最大长度。

## TCP可靠传输的实现

1. 以字节为单位的滑动窗口

2. 超时重传时间的选择

3. 选择确认SACK

## TCP的流量控制

1. 利用滑动窗口实现流量控制

**注意：可靠传输和流量控制是通过滑动窗口实现的，而拥塞控制是由拥塞窗口来控制的，两者切不可搞混！**

## TCP的拥塞控制

### 慢开始和拥塞避免
{% asset_img 慢开始和拥塞避免.JPG 慢开始和拥塞避免 %}

### 快重传和快恢复
{% asset_img 快重传和快恢复.JPG 快重传和快恢复 %}

## TCP的运输连接管理

### TCP三次握手
{% asset_img TCP三次握手.JPG TCP三次握手 %}

### TCP四次挥手
{% asset_img TCP连接释放过程.JPG TCP连接释放过程.JPG %}

### TCP的有限状态机
{% asset_img TCP的有限状态机.JPG TCP的有限状态机.JPG %}

### 为什么A在TIME-WAIT状态必须等待2MSL（最大报文段寿命，Maximum Segment Lifetime）？

&emsp;&emsp;第一，为了保证A发送的最后一个ACK报文段能够到达B。这个ACK报文段有可能丢失，因而使处在LAST-ACK状态的B收不到对已发送的FIN+ACK报文段的确认。B会超时重传这个FIN+ACK报文段，而A就能在2MSL时间内收到这个重传的FIN+ACK报文段。接着A重传一次确认，重新启动2MSL计时器。最后A和B都正常进入到CLOSED状态。如果A在TIME-WAIT状态不等待一段时间，而是在发送完ACK报文段后立即释放连接，那么就无法收到B重传的FIN+ACK报文段，因而也不会再发送一次确认报文段。这样，B就无法按照正常步骤进入CLOSED状态。

&emsp;&emsp;第二，防止“已失效的连接请求报文段”出现在本链接中。A在发送完最后一个ACK报文段后，再经过实践2MSL，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。B只要收到了A发出的确认，就进入CLOSED状态。同样，B在撤销响应的传输控制块TCB后，就结束了这次的TCP连接。